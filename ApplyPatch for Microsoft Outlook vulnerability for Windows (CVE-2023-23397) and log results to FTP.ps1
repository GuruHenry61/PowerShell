<#

This is for Microsoft Outlook vulnerability for Windows (CVE-2023-23397)

https://nvd.nist.gov/vuln/detail/CVE-2023-23397

...

#>

# FTP credentials and server address
$username = "username"
$password = "password"
$ftpServerIP = "IP"

# Create a log file with computer name
$Logfile = "$($env:computername)_OfficeUpdateLog.txt"
function LogWrite
{
    Param ([string]$logstring)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Add-content $Logfile -value "$timestamp $logstring"
}

function UploadToFTP
{
    Param (
        [string]$SourceFile,
        [string]$username,
        [string]$password,
        [string]$ftpServerIP
    )

    $uri = "ftp://$ftpServerIP/$($SourceFile.Split('\')[-1])"
    $webclient = New-Object System.Net.WebClient
    $webclient.Credentials = New-Object System.Net.NetworkCredential($username, $password)
    $webclient.UploadFile($uri, $SourceFile)
    LogWrite "File uploaded to FTP server: $uri"
}

#Check whether 64 bit office installed
$64Office = Test-Path "C:\Program Files\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe"
LogWrite "64 Bit Office installed: $64Office"

#If 64 bit Office installed, run this command silently
if ($64Office) {
    $updateProcess = Start-Process -FilePath "C:\Program Files\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe" -ArgumentList "/update user" -PassThru
    $updateProcess.WaitForExit()
    if ($updateProcess.ExitCode -eq 0) {
        LogWrite "64 Bit Office update applied successfully"
    } else {
        LogWrite "64 Bit Office update failed with exit code: $($updateProcess.ExitCode)"
    }
}

#Check whether 32 bit office installed
$32Office = Test-Path "C:\Program Files (x86)\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe"
LogWrite "32 Bit Office installed: $32Office"

#If 32 bit office installed, run this command silently
if ($32Office) {
    $updateProcess = Start-Process -FilePath "C:\Program Files (x86)\Common Files\microsoft shared\ClickToRun\OfficeC2RClient.exe" -ArgumentList "/update user" -PassThru
    $updateProcess.WaitForExit()
    if ($updateProcess.ExitCode -eq 0) {
        LogWrite "32 Bit Office update applied successfully"
    } else {
        LogWrite "32 Bit Office update failed with exit code: $($updateProcess.ExitCode)"
    }
}

# Upload log file to FTP server
UploadToFTP -SourceFile $Logfile -username $username -password $password -ftpServerIP $ftpServerIP
